---
layout: post
title: "ปลุกชีพ STM32: 3 วงจรหัวใจสำคัญ (Power, Clock, Reset)"
lang: th
ref: stm32-hardware-basics
permalink: /stm32-minimum-system/
description: "ก่อนเริ่มเขียนโค้ด ต้องมั่นใจว่าฮาร์ดแวร์พร้อม! สรุป 3 ปัจจัยพื้นฐาน STM32 ที่ต้องมี: ระบบไฟ (C-Decoupling), สัญญาณนาฬิกา (Oscillator) และระบบรีเซ็ต"
image: assets/images/stm32-heartbeat-cover.jpg
tags: [STM32, Hardware, ออกแบบ PCB, สอนใช้งาน]
---

<div class="adsense-slot"></div>

# บทนำ: ปัจจัย 4 ของ Microcontroller

ยินดีต้อนรับสู่คลาสเรียนฮาร์ดแวร์พื้นฐานครับ! วันนี้เราจะมาคุยเรื่องสิ่งที่เปรียบเสมือน "ปัจจัย 4" ของ MCU ถ้าขาดสิ่งเหล่านี้ไป ต่อให้โค้ดเทพแค่ไหน ชิปก็ไม่ทำงานครับ

ในฐานะ Technical Writer ของ **123Microcontroller** ผมสรุปเนื้อหาจาก Datasheet หนาๆ มาเป็นบทความย่อยง่ายๆ ว่าด้วย 3 สิ่งที่ต้องมีเพื่อ "ปลุกชีพ" STM32 ครับ:

1.  **Power Supply:** อาหารและเลือดหล่อเลี้ยง (ถ้าไม่มีแรง ก็คิดไม่ได้)
2.  **Oscillator:** จังหวะการเต้นของหัวใจ (ถ้าหัวใจไม่เต้น ระบบต่างๆ ก็ไม่เดิน)
3.  **Reset:** การปลุกให้ตื่น (ถ้ายังหลับอยู่ ก็สั่งงานไม่ได้)

**ระดับความยาก:** ⭐ ทฤษฎีพื้นฐานที่ต้องรู้
**เวลาที่ใช้:** ~15 นาที (อ่านทำความเข้าใจ)

## 1. ระบบไฟเลี้ยง (Power Supply) - "กองเสบียง"
โดยปกติ STM32F4 จะต้องการแรงดันไฟหลัก ($V_{DD}$) อยู่ในช่วง **1.8V ถึง 3.6V** โดยค่ามาตรฐานที่เราใช้กันทั่วไปคือ **3.3V** ครับ

### ทำไมต้องมี C (Capacitor) เต็มบอร์ด?
หากคุณดูในวงจร (Schematic) หรือบนบอร์ด Discovery คุณจะเห็นตัวเก็บประจุ (Capacitor) ตัวเล็กๆ วางอยู่ใกล้ขาไฟแทบทุกขา

* **กฎเหล็ก:** เราต้องใส่ C ค่า **100nF (0.1µF)** ไว้ใกล้ขา $V_{DD}$ *ทุกขา* และมี C ค่าใหญ่ **4.7µF** อีกหนึ่งตัวในไลน์ไฟหลัก
* **หน้าที่:** เปรียบเสมือน "แก้วน้ำส่วนตัว" ที่วางไว้ข้างตัว CPU ครับ เวลา CPU ประมวลผลหนักๆ หรือสลับสถานะ (0 เป็น 1) มันจะต้องการพลังงานกระชากแบบรวดเร็ว มันจะดูดน้ำจากแก้วนี้ทันที ถ้าต้องรอวิ่งไปกดจากตู้กดน้ำ (แหล่งจ่ายไฟหลัก) มันจะช้าไปและเกิดสัญญาณรบกวน (Noise) ครับ

### VCAP (ไฟเลี้ยงสมองใน)
ภายในชิป STM32 จะมีตัวแปลงไฟ (Voltage Regulator) ลดไฟจาก 3.3V เหลือประมาณ **1.2V** เพื่อเลี้ยงแกนกลาง CPU (Cortex-M4)
* **สิ่งที่ต้องทำ:** ขานี้ต้องต่อ C ค่า **2.2µF** (หรือ 4.7µF ตามรุ่น) ลงกราวด์ เพื่อรักษาแรงดันให้เรียบ
* **คำเตือน:** ⚠️ ห้ามต่อไฟภายนอกเข้าขานี้เด็ดขาดนะครับ!

## 2. สัญญาณนาฬิกา (Oscillators) - "จังหวะหัวใจ"
ชิปจะทำงานเป็นจังหวะตามสัญญาณนาฬิกา (Clock) ครับ ยิ่งเร็วยิ่งคำนวณไว แต่ก็แลกมาด้วยการกินไฟที่เพิ่มขึ้น STM32 มีแหล่งกำเนิดสัญญาณ 2 แบบหลักๆ:

### 2.1 ภายใน (HSI - High Speed Internal)
* คือวงจร RC Oscillator ที่ฝังอยู่ในตัวซิลิกอนของชิปเลย (ปกติ 16 MHz)
* **ข้อดี:** ฟรี! ไม่ต้องต่ออุปกรณ์เพิ่ม เปิดเครื่องปุ๊บ ชิปจะใช้ตัวนี้ก่อนเสมอ
* **ข้อเสีย:** ไม่ค่อยแม่นยำ (ความคลาดเคลื่อนประมาณ 1%) ถ้าเอาไปใช้กับ UART ความเร็วสูง หรือ USB อาจจะมีปัญหาได้

### 2.2 ภายนอก (HSE - High Speed External)
* คือการต่อ Crystal (คริสตัล) หรือ Ceramic Resonator ที่ขา `OSC_IN` และ `OSC_OUT`
* **สเปค:** รองรับความถี่ 4 ถึง 26 MHz (บนบอร์ด Discovery มักใช้ 8 MHz)
* **ข้อดี:** แม่นยำสูงมาก จำเป็นมากถ้าคุณจะทำระบบสื่อสาร หรือต้องการความเที่ยงตรงของเวลา

> **PLL (Phase Locked Loop):** นี่คือ "เทอร์โบ" ของชิปครับ มันจะเอาสัญญาณจาก HSI หรือ HSE (เช่น 8MHz) มาคูณความถี่ให้กลายเป็น **168 MHz** เพื่อให้ CPU วิ่งเต็มสปีด

![STM32 Minimum System Schematic Diagram]({{ site.baseurl }}/assets/images/stm32-schematic-diagram.jpg)
*รูปภาพแสดงโครงสร้าง Minimum System พื้นฐาน*

<div class="adsense-slot"></div>

## 3. วงจรรีเซ็ต (Reset Circuit) - "ปุ่มตื่น"
ขา Reset ของ STM32 ชื่อว่า **NRST** ทำงานแบบ **Active Low** (หมายความว่า ถ้าดึงขานี้ลงกราวด์ = รีเซ็ต, ถ้าปล่อยลอยเป็นไฟ 3.3V = ทำงานปกติ)

### ส่วนประกอบของวงจรที่แนะนำ:
1.  **ตัวเก็บประจุ (100nF):** ต่อระหว่างขา NRST กับกราวด์ เพื่อกรองสัญญาณรบกวน ไม่ให้ชิปเผลอรีเซ็ตตัวเองมั่วๆ
2.  **ปุ่มกด (Push Button):** ต่อลงกราวด์ เมื่อกดปุ่ม ไฟที่ขา NRST จะกลายเป็น 0V ทำให้ชิปเริ่มทำงานใหม่
3.  **Pull-up Resistor:** ปกติในตัวชิปมี Pull-up ให้อยู่แล้ว แต่เพื่อความชัวร์ (Robustness) เรามักจะต่อ R ค่า **10kΩ** ดึงไฟขึ้นไปที่ 3.3V ด้วยครับ

## แถม: Boot Configuration - "แผนที่นำทาง"
เมื่อชิปตื่นขึ้นมา (Reset เสร็จ) มันจะดูที่ขา **BOOT0** และ **BOOT1** ว่าจะให้ไปเอารหัสคำสั่งจากไหน

* **BOOT0 = 0 (ต่อลงกราวด์):** บูตจาก **Flash Memory** (นี่คือโหมดปกติที่เราเบิร์นโปรแกรมใส่เข้าไป)
* **BOOT0 = 1 (ต่อไฟ 3.3V):** บูตจาก **System Memory** (เอาไว้ลงโปรแกรมผ่านสาย Serial/USB หรือที่เรียกว่า Bootloader mode)

## สรุป (Summary Checklist)
หากคุณจะกัดแผ่น PCB ทำบอร์ด STM32 เอง อย่าลืมเช็คลิสต์นี้ก่อนสั่งผลิตครับ:

* ✅ จ่ายไฟ **3.3V** เข้าขา VDD ทุกขา และต่อกราวด์ให้ครบ
* ✅ ใส่ **C 100nF** ใกล้ขาไฟทุกจุด + **C 4.7µF** หนึ่งตัวตรงทางเข้า
* ✅ ต่อ **C ค่า 2.2µF** เข้าที่ขา **VCAP** (สำหรับไฟเลี้ยง Core)
* ✅ ต่อขา **BOOT0 ลงกราวด์** (ผ่าน R 10k) เพื่อให้รันโปรแกรมเราได้
* ✅ ถ้าต้องการความแม่นยำ อย่าลืมใส่ **Crystal 8MHz** ที่ขา OSC

เพียงเท่านี้ "หัวใจ" ของ STM32 ก็พร้อมเต้นและทำตามคำสั่งของคุณแล้วครับ!